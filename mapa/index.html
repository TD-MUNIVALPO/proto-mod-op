<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Solicitudes - MUNIVALPO</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../css/theme-vars.css">
  <link rel="stylesheet" href="../css/custom.css">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Leaflet MarkerCluster CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="mapaData()">

  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" :class="{ 'mobile-open': sidebarOpen }">
      <div class="sidebar-header">
        <div class="sidebar-title">MUNIVALPO</div>
      </div>

      <nav class="sidebar-nav">
        <a href="../index.html" class="sidebar-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          <span>Dashboard</span>
        </a>

        <a href="../bandeja/index.html" class="sidebar-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span>Bandeja de Solicitudes</span>
        </a>

        <a href="index.html" class="sidebar-nav-item active">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
          </svg>
          <span>Mapa de Solicitudes</span>
        </a>

        <a href="../historico/index.html" class="sidebar-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>Histórico</span>
        </a>
      </nav>

      <!-- PANEL DE FILTROS EN SIDEBAR -->
      <div class="px-4 pb-4">
        <div class="border-t pt-4" style="border-color: rgba(255,255,255,0.1)">
          <h4 class="text-sm font-semibold mb-3" style="color: var(--sidebar-text-active)">Filtros del Mapa</h4>

          <div class="mb-3">
            <label class="text-xs" style="color: var(--sidebar-text)">Estado</label>
            <select x-model="filtroEstado" @change="aplicarFiltros()" class="form-select text-sm mt-1">
              <option value="">Todos</option>
              <option value="0">Recepcionado</option>
              <option value="1">En Proceso</option>
              <option value="2">Finalizado</option>
              <option value="3">Rechazado</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="text-xs" style="color: var(--sidebar-text)">Departamento</label>
            <select x-model="filtroDepartamento" @change="aplicarFiltros()" class="form-select text-sm mt-1">
              <option value="">Todos</option>
              <template x-for="dept in departamentos" :key="dept.DepartamentoId">
                <option :value="dept.DepartamentoId" x-text="dept.Nombre"></option>
              </template>
            </select>
          </div>

          <button @click="limpiarFiltros()" class="btn-secondary btn-sm w-full">
            Limpiar filtros
          </button>
        </div>
      </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- HEADER -->
      <header class="header">
        <div class="flex items-center gap-4">
          <button @click="sidebarOpen = !sidebarOpen" class="btn-secondary btn-sm md:hidden">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
            </svg>
          </button>

          <h1 class="header-title">Mapa de Solicitudes</h1>

          <div class="hidden md:flex items-center gap-2 text-sm" style="color: var(--text-secondary)">
            <span class="badge badge-blue" x-text="`${solicitudesFiltradas.length} solicitudes`"></span>
          </div>
        </div>

        <div class="header-actions">
          <button @click="toggleTheme" class="theme-toggle" title="Cambiar tema">
            <svg x-show="tema === 'light'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
            <svg x-show="tema === 'dark'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
          </button>

          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">F</div>
            <span class="hidden md:inline text-sm font-medium">Funcionario Demo</span>
          </div>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <div class="content-area p-0">
        <!-- ESTADÍSTICAS RÁPIDAS (sobre el mapa) -->
        <div class="absolute top-4 left-4 z-10 flex gap-2">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-3 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-blue-500"></div>
            <div class="text-xs">
              <div style="color: var(--text-secondary)">Recepcionado</div>
              <div class="font-bold" x-text="stats.porEstado.recepcionado"></div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-3 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-yellow-500"></div>
            <div class="text-xs">
              <div style="color: var(--text-secondary)">En Proceso</div>
              <div class="font-bold" x-text="stats.porEstado.enProceso"></div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-3 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-green-500"></div>
            <div class="text-xs">
              <div style="color: var(--text-secondary)">Finalizado</div>
              <div class="font-bold" x-text="stats.porEstado.finalizado"></div>
            </div>
          </div>

          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-3 flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-red-500"></div>
            <div class="text-xs">
              <div style="color: var(--text-secondary)">Rechazado</div>
              <div class="font-bold" x-text="stats.porEstado.rechazado"></div>
            </div>
          </div>
        </div>

        <!-- MAPA -->
        <div id="main-map" class="map-full"></div>
      </div>
    </main>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="../js/mock-data.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    let map, markerClusterGroup;

    function mapaData() {
      return {
        sidebarOpen: false,
        tema: 'light',
        todasSolicitudes: [],
        solicitudesFiltradas: [],
        departamentos: [],
        filtroEstado: '',
        filtroDepartamento: '',
        stats: {
          porEstado: {
            recepcionado: 0,
            enProceso: 0,
            finalizado: 0,
            rechazado: 0
          }
        },

        init() {
          // Inicializar tema
          this.tema = inicializarTema();

          // Cargar datos
          this.todasSolicitudes = mockData.solicitudes
            .filter(s => s.LatitudGPS && s.LongitudGPS)
            .map(getSolicitudEnriquecida);

          this.departamentos = mockData.departamentos;

          // Aplicar filtros iniciales
          this.aplicarFiltros();

          // Inicializar mapa
          this.$nextTick(() => {
            this.inicializarMapa();
          });
        },

        aplicarFiltros() {
          const filtros = {
            estado: this.filtroEstado,
            departamento: this.filtroDepartamento
          };

          this.solicitudesFiltradas = filtrarSolicitudes(this.todasSolicitudes, filtros);
          this.calcularEstadisticas();
          this.actualizarMarcadores();
        },

        limpiarFiltros() {
          this.filtroEstado = '';
          this.filtroDepartamento = '';
          this.aplicarFiltros();
        },

        calcularEstadisticas() {
          this.stats = calcularEstadisticas(this.solicitudesFiltradas);
        },

        inicializarMapa() {
          // Centro en Valparaíso, Chile
          map = L.map('main-map').setView([-33.0472, -71.6127], 13);

          // Tile layer
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            maxZoom: 19
          }).addTo(map);

          // Crear grupo de markers con clustering
          markerClusterGroup = L.markerClusterGroup({
            chunkedLoading: true,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true
          });

          map.addLayer(markerClusterGroup);

          // Agregar marcadores
          this.actualizarMarcadores();

          // Ajustar vista si hay marcadores
          if (this.solicitudesFiltradas.length > 0) {
            const bounds = this.solicitudesFiltradas.map(s => [s.LatitudGPS, s.LongitudGPS]);
            map.fitBounds(bounds, { padding: [50, 50] });
          }
        },

        actualizarMarcadores() {
          if (!markerClusterGroup) return;

          // Limpiar marcadores existentes
          markerClusterGroup.clearLayers();

          // Agregar marcadores filtrados
          this.solicitudesFiltradas.forEach(solicitud => {
            const icon = this.getMarkerIcon(solicitud.Estado);
            const marker = L.marker(
              [solicitud.LatitudGPS, solicitud.LongitudGPS],
              { icon }
            );

            // Popup con información
            const popupContent = `
              <div class="p-2" style="min-width: 250px;">
                <h3 class="font-bold text-lg mb-2">Solicitud #${solicitud.SolicitudId}</h3>
                <div class="mb-2">
                  <span class="estado-badge ${getEstadoClass(solicitud.Estado)}">
                    ${getEstadoNombre(solicitud.Estado)}
                  </span>
                </div>
                <p class="text-sm mb-2"><strong>Descripción:</strong> ${solicitud.Descripcion.substring(0, 100)}...</p>
                <p class="text-sm mb-2"><strong>Solicitante:</strong> ${solicitud.NombreCiudadano}</p>
                <p class="text-sm mb-2"><strong>Departamento:</strong> ${solicitud.NombreDepartamento}</p>
                <p class="text-sm mb-3"><strong>Fecha:</strong> ${formatDate(solicitud.FechaCreacion)}</p>
                <a href="../bandeja/detalle.html?id=${solicitud.SolicitudId}" class="btn-primary btn-sm w-full text-center block">
                  Ver Detalle
                </a>
              </div>
            `;

            marker.bindPopup(popupContent, { maxWidth: 300 });
            markerClusterGroup.addLayer(marker);
          });

          // Ajustar vista si hay marcadores
          if (this.solicitudesFiltradas.length > 0) {
            const bounds = this.solicitudesFiltradas.map(s => [s.LatitudGPS, s.LongitudGPS]);
            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
          }
        },

        getMarkerIcon(estado) {
          const colores = {
            0: '#3b82f6',  // Recepcionado - Azul
            1: '#f59e0b',  // En Proceso - Amarillo
            2: '#10b981',  // Finalizado - Verde
            3: '#ef4444',  // Rechazado - Rojo
            4: '#8b5cf6'   // Derivado - Púrpura
          };

          const color = colores[estado] || '#6b7280';

          return L.divIcon({
            className: 'custom-marker',
            html: `
              <div style="
                width: 30px;
                height: 30px;
                background-color: ${color};
                border: 3px solid white;
                border-radius: 50%;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
              "></div>
            `,
            iconSize: [30, 30],
            iconAnchor: [15, 15],
            popupAnchor: [0, -15]
          });
        },

        toggleTheme() {
          this.tema = toggleTheme();
        },

        // Funciones de utilidad
        getEstadoClass,
        getEstadoNombre,
        formatDate
      }
    }
  </script>

  <style>
    /* Estilos adicionales para el mapa */
    #main-map {
      width: 100%;
      height: calc(100vh - var(--header-height));
    }

    .leaflet-popup-content-wrapper {
      border-radius: var(--radius-lg);
    }

    .leaflet-popup-content {
      margin: 0;
      font-family: inherit;
    }

    /* Ajustar stats cards sobre el mapa para dark mode */
    [data-theme="dark"] .absolute.top-4 > div {
      background-color: var(--bg-secondary) !important;
    }

    /* Mejorar visibilidad de clusters */
    .marker-cluster-small,
    .marker-cluster-medium,
    .marker-cluster-large {
      background-color: rgba(59, 130, 246, 0.6);
    }

    .marker-cluster-small div,
    .marker-cluster-medium div,
    .marker-cluster-large div {
      background-color: rgba(37, 99, 235, 0.8);
      color: white;
      font-weight: bold;
    }
  </style>
</body>
</html>
