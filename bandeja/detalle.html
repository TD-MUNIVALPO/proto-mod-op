<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detalle de Solicitud - MUNIVALPO</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Custom CSS -->
  <link rel="stylesheet" href="../css/theme-vars.css">
  <link rel="stylesheet" href="../css/custom.css">

  <!-- Leaflet CSS para mapas -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="detalleData()">

  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" :class="{ 'mobile-open': sidebarOpen }">
      <div class="sidebar-header">
        <div class="sidebar-title">MUNIVALPO</div>
      </div>

      <nav class="sidebar-nav">
        <a href="../index.html" class="sidebar-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
          </svg>
          <span>Dashboard</span>
        </a>

        <a href="index.html" class="sidebar-nav-item active">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
          </svg>
          <span>Bandeja de Solicitudes</span>
        </a>

        <a href="../mapa/index.html" class="sidebar-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
          </svg>
          <span>Mapa de Solicitudes</span>
        </a>

        <a href="../historico/index.html" class="sidebar-nav-item">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>Hist√≥rico</span>
        </a>
      </nav>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
      <!-- HEADER -->
      <header class="header">
        <div class="flex items-center gap-4">
          <a href="index.html" class="btn-secondary btn-sm">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            Volver
          </a>

          <h1 class="header-title">
            Solicitud <span x-text="`#${solicitud?.SolicitudId || ''}`"></span>
          </h1>
        </div>

        <div class="header-actions">
          <button @click="toggleTheme" class="theme-toggle" title="Cambiar tema">
            <svg x-show="tema === 'light'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
            </svg>
            <svg x-show="tema === 'dark'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/>
            </svg>
          </button>
        </div>
      </header>

      <!-- CONTENT AREA -->
      <div class="content-area">
        <template x-if="!solicitud">
          <div class="alert alert-error">
            Solicitud no encontrada
          </div>
        </template>

        <template x-if="solicitud">
          <div>
            <!-- HEADER CON ACCIONES -->
            <div class="card mb-6">
              <div class="card-body">
                <div class="flex items-start justify-between mb-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <h2 class="text-2xl font-bold" x-text="`Solicitud #${solicitud.SolicitudId}`"></h2>
                      <span class="estado-badge" :class="getEstadoClass(solicitud.Estado)" x-text="getEstadoNombre(solicitud.Estado)"></span>
                      <span class="etapa-badge" :class="getEtapaClass(solicitud.EtapaSolicitud)" x-text="getEtapaNombre(solicitud.EtapaSolicitud)"></span>
                    </div>
                    <p class="text-sm" style="color: var(--text-secondary)">
                      Creada <span x-text="tiempoTranscurrido(solicitud.FechaCreacion)"></span>
                      (<span x-text="formatDate(solicitud.FechaCreacion)"></span>)
                    </p>
                  </div>

                  <div class="flex gap-2">
                    <button @click="modalManager.abrir('modal-editar')" class="btn-secondary btn-sm">
                      ‚úèÔ∏è Editar
                    </button>
                    <button @click="modalManager.abrir('modal-eliminar')" class="btn-danger btn-sm">
                      üóëÔ∏è Eliminar
                    </button>
                  </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <button @click="modalManager.abrir('modal-derivar')" class="btn-primary">
                    ‚û°Ô∏è Derivar
                  </button>
                  <button @click="modalManager.abrir('modal-validar')" class="btn-primary">
                    ‚úÖ Validar
                  </button>
                  <button @click="modalManager.abrir('modal-cambiar-estado')" class="btn-secondary">
                    üîÑ Cambiar Estado
                  </button>
                  <button @click="modalManager.abrir('modal-cambiar-etapa')" class="btn-secondary">
                    üìã Cambiar Etapa
                  </button>
                </div>
              </div>
            </div>

            <!-- GRID DE INFORMACI√ìN -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
              <!-- INFORMACI√ìN DEL SOLICITANTE -->
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">üë§ Solicitante</h3>
                </div>
                <div class="card-body">
                  <div class="space-y-3">
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">Nombre Completo</label>
                      <p class="font-medium" x-text="solicitud.NombreCiudadano"></p>
                    </div>
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">RUT</label>
                      <p x-text="formatRut(solicitud.RUTCiudadano)"></p>
                    </div>
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">Email</label>
                      <p x-text="solicitud.EmailCiudadano"></p>
                    </div>
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">Tel√©fono</label>
                      <p x-text="solicitud.TelefonoCiudadano || 'No especificado'"></p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- INFORMACI√ìN DEL DEPARTAMENTO -->
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">üè¢ Departamento</h3>
                </div>
                <div class="card-body">
                  <div class="space-y-3">
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">Departamento Asignado</label>
                      <p class="font-medium" x-text="solicitud.NombreDepartamento"></p>
                    </div>
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">Funcionario Responsable</label>
                      <p x-text="solicitud.NombreFuncionario"></p>
                    </div>
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">Tipo de Ingreso</label>
                      <p>
                        <span x-text="getTipoIngresoIcon(solicitud.TipoIngreso)"></span>
                        <span x-text="getTipoIngresoNombre(solicitud.TipoIngreso)"></span>
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- INFORMACI√ìN DEL REQUERIMIENTO -->
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">üìÑ Requerimiento</h3>
                </div>
                <div class="card-body">
                  <div class="space-y-3">
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">Tipo de Requerimiento</label>
                      <p class="font-medium" x-text="solicitud.NombreRequerimiento"></p>
                    </div>
                    <div x-show="solicitud.PrecioRequerimiento">
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">Precio</label>
                      <p class="font-bold text-green-600" x-text="solicitud.PrecioRequerimiento"></p>
                    </div>
                    <div>
                      <label class="text-xs font-semibold" style="color: var(--text-secondary)">D√≠as Transcurridos</label>
                      <p>
                        <span
                          :class="diasTranscurridos(solicitud.FechaCreacion) > 15 ? 'text-red-600 font-bold' : ''"
                          x-text="`${diasTranscurridos(solicitud.FechaCreacion)} d√≠as`"
                        ></span>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- DESCRIPCI√ìN Y OBSERVACI√ìN -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">üìù Descripci√≥n</h3>
                </div>
                <div class="card-body">
                  <p x-text="solicitud.Descripcion"></p>
                </div>
              </div>

              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">üí¨ Observaci√≥n</h3>
                </div>
                <div class="card-body">
                  <p x-text="solicitud.Observacion || 'Sin observaciones'"></p>
                </div>
              </div>
            </div>

            <!-- UBICACI√ìN -->
            <div class="card mb-6" x-show="solicitud.LatitudGPS && solicitud.LongitudGPS">
              <div class="card-header">
                <h3 class="card-title">üìç Ubicaci√≥n</h3>
                <button @click="modalManager.abrir('modal-ver-mapa')" class="btn-secondary btn-sm">
                  Ver mapa completo
                </button>
              </div>
              <div class="card-body">
                <div class="grid grid-cols-2 gap-4 mb-4">
                  <div>
                    <label class="text-xs font-semibold" style="color: var(--text-secondary)">Latitud</label>
                    <p x-text="solicitud.LatitudGPS"></p>
                  </div>
                  <div>
                    <label class="text-xs font-semibold" style="color: var(--text-secondary)">Longitud</label>
                    <p x-text="solicitud.LongitudGPS"></p>
                  </div>
                </div>
                <div id="mini-map" class="map-container" style="height: 300px;"></div>
              </div>
            </div>

            <!-- DERIVACIONES, VALIDACIONES Y ETAPAS -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
              <!-- DERIVACIONES -->
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">‚û°Ô∏è Derivaciones</h3>
                </div>
                <div class="card-body">
                  <div class="timeline" x-show="derivaciones.length > 0">
                    <template x-for="der in derivaciones" :key="der.DerivacionId">
                      <div class="timeline-item">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content">
                          <div class="timeline-header">
                            <span class="timeline-title" x-text="`Derivada a ${der.NombreDepartamentoDestino}`"></span>
                            <span class="timeline-date" x-text="formatDate(der.FechaCreacion)"></span>
                          </div>
                          <div class="timeline-body">
                            <p x-text="der.ObservacionDerivacion"></p>
                            <p class="text-xs mt-1">Por: <span x-text="der.NombreFuncionario"></span></p>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                  <p x-show="derivaciones.length === 0" class="text-sm" style="color: var(--text-secondary)">
                    No hay derivaciones registradas
                  </p>
                </div>
              </div>

              <!-- VALIDACIONES -->
              <div class="card">
                <div class="card-header">
                  <h3 class="card-title">‚úÖ Validaciones</h3>
                </div>
                <div class="card-body">
                  <div class="timeline" x-show="validaciones.length > 0">
                    <template x-for="val in validaciones" :key="val.ValidacionId">
                      <div class="timeline-item">
                        <div class="timeline-dot" :style="`background-color: ${val.Aprobado ? 'var(--color-success)' : 'var(--color-error)'}`"></div>
                        <div class="timeline-content">
                          <div class="timeline-header">
                            <span class="timeline-title">
                              <span x-text="val.Aprobado ? '‚úÖ Aprobada' : '‚ùå Rechazada'"></span>
                            </span>
                            <span class="timeline-date" x-text="formatDate(val.FechaValidacion)"></span>
                          </div>
                          <div class="timeline-body">
                            <p x-text="val.ObservacionValidacion"></p>
                            <p class="text-xs mt-1">Por: <span x-text="val.NombreFuncionario"></span></p>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                  <p x-show="validaciones.length === 0" class="text-sm" style="color: var(--text-secondary)">
                    No hay validaciones registradas
                  </p>
                </div>
              </div>
            </div>

            <!-- ETAPAS -->
            <div class="card mb-6">
              <div class="card-header">
                <h3 class="card-title">üîÑ Etapas del Proceso</h3>
                <button @click="modalManager.abrir('modal-agregar-etapa')" class="btn-primary btn-sm">
                  + Agregar Etapa
                </button>
              </div>
              <div class="card-body">
                <div class="timeline" x-show="etapas.length > 0">
                  <template x-for="etapa in etapas" :key="etapa.EtapaId">
                    <div class="timeline-item">
                      <div class="timeline-dot"></div>
                      <div class="timeline-content">
                        <div class="timeline-header">
                          <span class="timeline-title" x-text="etapa.NombreTipoEtapa"></span>
                          <span class="timeline-date" x-text="formatDate(etapa.FechaInicio)"></span>
                        </div>
                        <div class="timeline-body">
                          <p x-text="etapa.Observacion"></p>
                          <div class="flex gap-2 mt-2">
                            <span class="text-xs badge badge-gray">
                              Inicio: <span x-text="formatDate(etapa.FechaInicio, false)"></span>
                            </span>
                            <span x-show="etapa.FechaFin" class="text-xs badge badge-gray">
                              Fin: <span x-text="formatDate(etapa.FechaFin, false)"></span>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
                <p x-show="etapas.length === 0" class="text-sm" style="color: var(--text-secondary)">
                  No hay etapas registradas
                </p>
              </div>
            </div>

            <!-- ARCHIVOS ADJUNTOS -->
            <div class="card mb-6">
              <div class="card-header">
                <h3 class="card-title">üìé Archivos Adjuntos</h3>
                <button @click="modalManager.abrir('modal-adjuntar')" class="btn-primary btn-sm">
                  + Adjuntar Archivo
                </button>
              </div>
              <div class="card-body">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" x-show="anexos.length > 0">
                  <template x-for="archivo in anexos" :key="archivo.AnexoId">
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow" style="border-color: var(--border-color)">
                      <div class="flex items-start gap-3">
                        <div class="text-3xl">üìÑ</div>
                        <div class="flex-1 min-w-0">
                          <p class="font-medium truncate" x-text="archivo.NombreArchivo"></p>
                          <p class="text-xs truncate" style="color: var(--text-secondary)" x-text="archivo.Descripcion"></p>
                          <p class="text-xs mt-1" style="color: var(--text-secondary)" x-text="formatDate(archivo.FechaCreacion)"></p>
                          <button class="btn-secondary btn-sm mt-2">Descargar</button>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
                <p x-show="anexos.length === 0" class="text-sm" style="color: var(--text-secondary)">
                  No hay archivos adjuntos
                </p>
              </div>
            </div>

            <!-- BOT√ìN VER HISTORIAL COMPLETO -->
            <div class="flex justify-center">
              <button @click="modalManager.abrir('modal-historial')" class="btn-primary btn-lg">
                üìú Ver Historial Completo
              </button>
            </div>
          </div>
        </template>
      </div>
    </main>
  </div>

  <!-- MODALES -->

  <!-- Modal Editar Solicitud -->
  <div id="modal-editar" class="modal-overlay">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Editar Solicitud</h3>
        <button @click="modalManager.cerrar('modal-editar')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Descripci√≥n</label>
          <textarea id="edit-descripcion" class="form-textarea" rows="4"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">Observaci√≥n</label>
          <textarea id="edit-observacion" class="form-textarea" rows="3"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">Latitud GPS</label>
            <input type="text" id="edit-latitud" class="form-input" placeholder="-33.0472">
          </div>
          <div class="form-group">
            <label class="form-label">Longitud GPS</label>
            <input type="text" id="edit-longitud" class="form-input" placeholder="-71.6127">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button @click="modalManager.cerrar('modal-editar')" class="btn-secondary">Cancelar</button>
        <button @click="guardarEdicionSolicitud()" class="btn-primary">Guardar Cambios</button>
      </div>
    </div>
  </div>

  <!-- Modal Derivar -->
  <div id="modal-derivar" class="modal-overlay">
    <div class="modal modal-md">
      <div class="modal-header">
        <h3 class="modal-title">‚û°Ô∏è Derivar Solicitud</h3>
        <button @click="modalManager.cerrar('modal-derivar')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Departamento Destino</label>
          <select id="derivar-departamento" class="form-select">
            <option value="">Seleccione...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label required">Funcionario Responsable</label>
          <select id="derivar-funcionario" class="form-select">
            <option value="">Seleccione...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label required">Observaci√≥n</label>
          <textarea id="derivar-observacion" class="form-textarea" rows="4" placeholder="Motivo de la derivaci√≥n..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button @click="modalManager.cerrar('modal-derivar')" class="btn-secondary">Cancelar</button>
        <button @click="guardarDerivacion()" class="btn-primary">Derivar</button>
      </div>
    </div>
  </div>

  <!-- Modal Validar -->
  <div id="modal-validar" class="modal-overlay">
    <div class="modal modal-md">
      <div class="modal-header">
        <h3 class="modal-title">‚úÖ Validar Solicitud</h3>
        <button @click="modalManager.cerrar('modal-validar')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Resultado de la Validaci√≥n</label>
          <div class="flex gap-4">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="validacion" id="validar-aprobado" value="true" checked>
              <span class="text-green-600 font-semibold">‚úÖ Aprobar</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="radio" name="validacion" value="false">
              <span class="text-red-600 font-semibold">‚ùå Rechazar</span>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label required">Observaci√≥n</label>
          <textarea id="validar-observacion" class="form-textarea" rows="4" placeholder="Comentarios de la validaci√≥n..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button @click="modalManager.cerrar('modal-validar')" class="btn-secondary">Cancelar</button>
        <button @click="guardarValidacion()" class="btn-success">Guardar Validaci√≥n</button>
      </div>
    </div>
  </div>

  <!-- Modal Cambiar Estado -->
  <div id="modal-cambiar-estado" class="modal-overlay">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h3 class="modal-title">üîÑ Cambiar Estado</h3>
        <button @click="modalManager.cerrar('modal-cambiar-estado')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Nuevo Estado</label>
          <select id="nuevo-estado" class="form-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Observaci√≥n</label>
          <textarea id="estado-observacion" class="form-textarea" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button @click="modalManager.cerrar('modal-cambiar-estado')" class="btn-secondary">Cancelar</button>
        <button @click="guardarCambioEstado()" class="btn-primary">Cambiar Estado</button>
      </div>
    </div>
  </div>

  <!-- Modal Cambiar Etapa -->
  <div id="modal-cambiar-etapa" class="modal-overlay">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h3 class="modal-title">üìã Cambiar Etapa</h3>
        <button @click="modalManager.cerrar('modal-cambiar-etapa')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Nueva Etapa</label>
          <select id="nueva-etapa" class="form-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Observaci√≥n</label>
          <textarea id="etapa-cambio-observacion" class="form-textarea" rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button @click="modalManager.cerrar('modal-cambiar-etapa')" class="btn-secondary">Cancelar</button>
        <button @click="guardarCambioEtapa()" class="btn-primary">Cambiar Etapa</button>
      </div>
    </div>
  </div>

  <!-- Modal Adjuntar Archivo -->
  <div id="modal-adjuntar" class="modal-overlay">
    <div class="modal modal-md">
      <div class="modal-header">
        <h3 class="modal-title">üìé Adjuntar Archivo</h3>
        <button @click="modalManager.cerrar('modal-adjuntar')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Archivo</label>
          <input type="file" id="archivo-input" class="form-input" @change="previewArchivo($event.target)">
        </div>
        <div id="archivo-preview"></div>
        <div class="form-group">
          <label class="form-label">Descripci√≥n</label>
          <textarea id="archivo-descripcion" class="form-textarea" rows="3" placeholder="Descripci√≥n del archivo..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button @click="modalManager.cerrar('modal-adjuntar')" class="btn-secondary">Cancelar</button>
        <button @click="guardarArchivo()" class="btn-primary">Adjuntar</button>
      </div>
    </div>
  </div>

  <!-- Modal Agregar Etapa -->
  <div id="modal-agregar-etapa" class="modal-overlay">
    <div class="modal modal-md">
      <div class="modal-header">
        <h3 class="modal-title">üîÑ Agregar Etapa</h3>
        <button @click="modalManager.cerrar('modal-agregar-etapa')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">Tipo de Etapa</label>
          <select id="etapa-tipo" class="form-select"></select>
        </div>
        <div class="form-group">
          <label class="form-label">Observaci√≥n</label>
          <textarea id="etapa-observacion" class="form-textarea" rows="3"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-4">
          <div class="form-group">
            <label class="form-label">Fecha Inicio</label>
            <input type="date" id="etapa-fecha-inicio" class="form-input">
          </div>
          <div class="form-group">
            <label class="form-label">Fecha Fin</label>
            <input type="date" id="etapa-fecha-fin" class="form-input">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button @click="modalManager.cerrar('modal-agregar-etapa')" class="btn-secondary">Cancelar</button>
        <button @click="guardarNuevaEtapa()" class="btn-primary">Agregar Etapa</button>
      </div>
    </div>
  </div>

  <!-- Modal Ver Mapa -->
  <div id="modal-ver-mapa" class="modal-overlay">
    <div class="modal modal-xl">
      <div class="modal-header">
        <h3 class="modal-title">üìç Ubicaci√≥n en el Mapa</h3>
        <button @click="modalManager.cerrar('modal-ver-mapa')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body p-0">
        <div id="modal-map" style="height: 600px; width: 100%;"></div>
      </div>
    </div>
  </div>

  <!-- Modal Historial -->
  <div id="modal-historial" class="modal-overlay">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h3 class="modal-title">üìú Historial Completo</h3>
        <button @click="modalManager.cerrar('modal-historial')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div id="historial-container" class="timeline"></div>
      </div>
    </div>
  </div>

  <!-- Modal Eliminar -->
  <div id="modal-eliminar" class="modal-overlay">
    <div class="modal modal-sm">
      <div class="modal-header">
        <h3 class="modal-title">üóëÔ∏è Eliminar Solicitud</h3>
        <button @click="modalManager.cerrar('modal-eliminar')" class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="alert alert-error mb-4">
          <strong>‚ö†Ô∏è Advertencia:</strong> Esta acci√≥n no se puede deshacer.
        </div>
        <p class="mb-4">¬øEst√° seguro que desea eliminar esta solicitud?</p>
        <div id="eliminar-info" class="p-4 rounded" style="background-color: var(--bg-secondary)"></div>
      </div>
      <div class="modal-footer">
        <button @click="modalManager.cerrar('modal-eliminar')" class="btn-secondary">Cancelar</button>
        <button @click="confirmarEliminacion()" class="btn-danger">Eliminar Definitivamente</button>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="../js/mock-data.js"></script>
  <script src="../js/utils.js"></script>
  <script src="../js/modals.js"></script>

  <script>
    let miniMap, modalMap;

    function detalleData() {
      return {
        sidebarOpen: false,
        tema: 'light',
        solicitudId: null,
        solicitud: null,
        derivaciones: [],
        validaciones: [],
        etapas: [],
        anexos: [],
        modalManager: null,

        init() {
          // Inicializar tema
          this.tema = inicializarTema();

          // Obtener ID de la URL
          const params = getURLParams();
          this.solicitudId = parseInt(params.id);

          if (!this.solicitudId) {
            mostrarNotificacion('ID de solicitud no especificado', 'error');
            return;
          }

          // Cargar datos
          this.cargarDatos();

          // Inicializar modal manager
          this.modalManager = inicializarModalesDetalle(this.solicitudId);

          // Inicializar mapa si hay coordenadas
          this.$nextTick(() => {
            if (this.solicitud?.LatitudGPS && this.solicitud?.LongitudGPS) {
              this.inicializarMiniMapa();
            }
          });
        },

        cargarDatos() {
          // Cargar solicitud enriquecida (buscar por idSolicitud que es el campo en mockData)
          const solicitudBase = mockData.solicitudes.find(s => s.idSolicitud === this.solicitudId);
          if (!solicitudBase) {
            mostrarNotificacion('Solicitud no encontrada', 'error');
            return;
          }

          this.solicitud = getSolicitudEnriquecida(solicitudBase);

          // Cargar derivaciones (usar camelCase para buscar en mockData)
          this.derivaciones = mockData.derivaciones
            .filter(d => d.solicitudId === this.solicitudId)
            .map(d => ({
              DerivacionId: d.derivacionId,
              SolicitudId: d.solicitudId,
              FuncionarioId: d.funcionarioId,
              DepartamentoOrigenId: d.departamentoOrigenId,
              DepartamentoDestinoId: d.departamentoDestinoId,
              ObservacionDerivacion: d.observacionDerivacion,
              FechaCreacion: d.fechaCreacion,
              NombreFuncionario: mockData.funcionarios.find(f => f.id === d.funcionarioId)?.nombres || '',
              NombreDepartamentoDestino: mockData.departamentos.find(dep => dep.id === d.departamentoDestinoId)?.nombre || ''
            }));

          // Cargar validaciones (relacionadas a trav√©s de derivaciones)
          const derivacionesIds = this.derivaciones.map(d => d.DerivacionId);
          this.validaciones = mockData.validaciones
            .filter(v => derivacionesIds.includes(v.derivacionId))
            .map(v => ({
              ValidacionId: v.validacionId,
              DerivacionId: v.derivacionId,
              Aprobado: v.validacionEstado,
              ObservacionValidacion: v.observacionValidacion,
              FechaValidacion: v.fechaCreacion,
              SolicitudId: this.solicitudId,
              NombreFuncionario: 'Funcionario Validador'
            }));

          // Cargar etapas (relacionadas a trav√©s de validaciones)
          const validacionesIds = this.validaciones.map(v => v.ValidacionId);
          this.etapas = mockData.etapas
            .filter(e => validacionesIds.includes(e.validacionId))
            .map(e => ({
              EtapaId: e.etapaId,
              ValidacionId: e.validacionId,
              TipoEtapaId: e.tipoEtapaId,
              Observacion: e.observacion,
              FechaInicio: e.fechaCreacion,
              FechaFin: null,
              SolicitudId: this.solicitudId,
              NombreTipoEtapa: mockData.tiposEtapa.find(t => t.id === e.tipoEtapaId)?.nombre || '',
              Archivo1: e.archivos?.[0]?.nombreOriginal || null
            }));

          // Cargar anexos (simular algunos)
          this.anexos = this.etapas
            .filter(e => e.Archivo1 || e.Archivo2 || e.Archivo3)
            .flatMap(e => {
              const archivos = [];
              if (e.Archivo1) archivos.push({
                AnexoId: `${e.EtapaId}-1`,
                NombreArchivo: e.Archivo1,
                Descripcion: `Archivo de etapa ${e.NombreTipoEtapa}`,
                FechaCreacion: e.FechaInicio
              });
              return archivos;
            });
        },

        inicializarMiniMapa() {
          if (!this.solicitud?.LatitudGPS || !this.solicitud?.LongitudGPS) return;

          try {
            miniMap = L.map('mini-map').setView(
              [this.solicitud.LatitudGPS, this.solicitud.LongitudGPS],
              15
            );

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '¬© OpenStreetMap contributors'
            }).addTo(miniMap);

            L.marker([this.solicitud.LatitudGPS, this.solicitud.LongitudGPS])
              .addTo(miniMap)
              .bindPopup(`<b>Solicitud #${this.solicitud.SolicitudId}</b><br>${this.solicitud.Descripcion}`)
              .openPopup();
          } catch (error) {
            console.error('Error al inicializar mapa:', error);
          }
        },

        toggleTheme() {
          this.tema = toggleTheme();
        },

        // Funciones de utilidad
        getEstadoClass,
        getEstadoNombre,
        getEtapaClass,
        getEtapaNombre,
        getTipoIngresoNombre,
        getTipoIngresoIcon,
        formatDate,
        formatRut,
        diasTranscurridos,
        tiempoTranscurrido
      }
    }

    function inicializarMapaModal(lat, lng) {
      try {
        if (modalMap) {
          modalMap.remove();
        }

        modalMap = L.map('modal-map').setView([lat, lng], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '¬© OpenStreetMap contributors'
        }).addTo(modalMap);

        L.marker([lat, lng])
          .addTo(modalMap)
          .bindPopup('<b>Ubicaci√≥n de la solicitud</b>')
          .openPopup();
      } catch (error) {
        console.error('Error al inicializar mapa modal:', error);
      }
    }
  </script>
</body>
</html>
